/*! DMAssassins - v0.9.0 - 2014-10-05
* http://dmassassins.com
* Copyright (c) 2014 Matt Gerstman; Licensed  */
function statusChangeCallback(a){app.Session.get("authenticated")&&("connected"===a.status?app.Session.createSession(a,function(){}):app.Running.Router.navigate("login"))}var AuthUtils={getRolesMap:function(){var a={dm_user:{value:0,pretty_name:"User"},dm_captain:{value:1,pretty_name:"Captain"},dm_admin:{value:2,pretty_name:"Admin"},dm_super_admin:{value:3,pretty_name:"Super Admin"}};return a},getRolesMapFor:function(a,b){if(!a)return{};var c={},d=this.getRolesMap();for(var e in d)(b!==!1||1!=d[e].value)&&d[e].value<=d[a].value&&(c[e]=d[e]);return c},getRolePrettyName:function(a){var b=this.getRolesMap();return b[a].pretty_name},isRoleAllowed:function(a,b){var c=this.getRolesMap();return void 0===a||void 0===c[a]?void 0:c[a].value>=c[b].value},requiresUser:function(a){return this.isRoleAllowed(a,"dm_user")},requiresCaptain:function(a){return this.isRoleAllowed(a,"dm_captain")},requiresAdmin:function(a){return this.isRoleAllowed(a,"dm_admin")},requiresSuperAdmin:function(a){return this.isRoleAllowed(a,"dm_super_admin")}},SPY="/assets/img/spy.jpg",app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};window.fbAsyncInit=function(){FB.init({appId:config.APP_ID,cookie:!0,xfbml:!0,version:"v2.0",status:!0}),app.Running.FB=FB,FB.getLoginStatus(function(a){statusChangeCallback(a)})},function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk");var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){"use strict";app.Models.Game=Backbone.Model.extend({defaults:{game_id:"",game_name:"Loading...",game_started:!1,game_has_password:!1,member:!0},idAttribute:"game_id",urlRoot:config.WEB_ROOT+"user/",areTeamsEnabled:function(){return"true"==this.getProperty("teams_enabled")},getProperty:function(a){var b=this.get("game_properties");return b?void 0===b[a]?null:b[a]:null},fetchProperties:function(){var a=this.gameUrl();return this.fetch({url:a})},gameUrl:function(){var a=config.WEB_ROOT+"game/"+this.get("game_id")+"/";return a},url:function(){var a=this.urlRoot;a+=app.Session.get("user_id")+"/game/";var b=this.get("game_id");return b?a+b+"/":a}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){"use strict";app.Models.Leaderboard=Backbone.Model.extend({defaults:{teams_enabled:!0,user_col_width:20,team_col_width:20,users:[{name:"Loading...",kills:"Loading...",team_name:"Loading..."},{name:"Loading...",kills:"Loading...",team_name:"Loading..."}],teams:[{"Loading...":"Loading..."}]},parse:function(a){return a.user_col_width=100/(3+this.get("teams_enabled")),a.team_col_width=20,a},url:function(){var a=app.Running.Games.getActiveGameId();return config.WEB_ROOT+"game/"+a+"/leaderboard/"}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){"use strict";app.Models.Rules=Backbone.Model.extend({defaults:{rules:"Loading..."},url:function(){var a=app.Running.Games.getActiveGameId();return config.WEB_ROOT+"game/"+a+"/rules/"}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){app.Models.Session=Backbone.Model.extend({url:config.WEB_ROOT+"session/",initialize:function(){Storage&&sessionStorage&&(this.supportStorage=!0)},get:function(a){if(this.supportStorage){var b=sessionStorage.getItem(a);return b&&"{"===b[0]?JSON.parse(b):b}return Backbone.Model.prototype.get.call(this,a)},set:function(a,b){return this.supportStorage?sessionStorage.setItem(a,b):Backbone.Model.prototype.set.call(this,a,b),this},unset:function(a){return this.supportStorage?sessionStorage.removeItem(a):Backbone.Model.prototype.unset.call(this,a),this},clear:function(){this.supportStorage?sessionStorage.clear():Backbone.Model.prototype.clear(this)},login:function(){var a=this;FB.getLoginStatus(function(b){"connected"===b.status?a.createSession(b):"not_authorized"===b.status?FB.login(function(b){a.createSession(b)},{scope:"public_profile,email,user_friends,user_photos"}):FB.login(function(b){a.createSession(b)},{scope:"public_profile,email,user_friends,user_photos"})})},createSession:function(a){var b=this.get("game_id"),c={facebook_id:a.authResponse.userID,facebook_token:a.authResponse.accessToken,game_id:b},d=this,e=$.ajax({url:this.url,data:c,type:"POST"});e.done(function(a){var b=app.Running.Games.parse(a.games),c=b||{},e=a.game||{game_id:null},f=a.user||{user_id:null},g=a.target||{assassin_id:f.user_id},h=a.leaderboard||{},i=null;e.game_properties&&(i={rules:e.game_properties.rules||null}),g.assassin_id=a.user.user_id,app.Running.User.set(f),app.Running.TargetModel.set(g),app.Running.LeaderboardModel.set(h),app.Running.RulesModel.set(i),app.Running.Games.reset(c),d.storeSession(a),app.Running.Games.setActiveGame(e.game_id,!0),app.Running.Games.getActiveGame().set(e);var j=app.Running.Router.requiresTarget,k=Backbone.history.fragment;return"login"==k||_.contains(j,k)?"login"==k&&app.Running.TargetModel.get("user_id")?void Backbone.history.navigate("#",{trigger:!0}):void Backbone.history.navigate("#my_profile",{trigger:!0}):void Backbone.history.loadUrl()}),e.fail(function(){d.clear(),FB.getLoginStatus(function(a){statusChangeCallback(a)}),Backbone.history.navigate("login",{trigger:!0})})},storeSession:function(a){this.set("authenticated",!0),this.set("has_game",null!==a.game),this.storeBasicAuth(a)},storeBasicAuth:function(a){var b=a.user.user_id;this.set("user_id",b);var c=a.token,d=b+":"+c,e=window.btoa(d);this.set("authKey",e),this.setAuthHeader()},setAuthHeader:function(){var a=this.get("authKey");$.ajaxSetup({headers:{Authorization:"Basic "+a}})}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){"use strict";app.Models.Target=Backbone.Model.extend({defaults:{game_id:null,assassin_id:"",username:"",user_id:"",properties:{name:"Loading...",facebook:"Loading...",team:"Loading...",photo_thumb:SPY,photo:SPY}},url:function(){var a=app.Running.Games.getActiveGameId();return config.WEB_ROOT+"game/"+a+"/user/"+this.get("assassin_id")+"/target/"},initialize:function(){this.get("assassin_id")||(this.assassin_id=app.Session.get("user_id")),this.idAttribute="assassin_id"}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){"use strict";app.Models.Team=Backbone.Model.extend({defaults:{user_id:"",team_id:"",team_name:""},idAttribute:"team_id",url:function(){var a=app.Running.Games.getActiveGameId(),b=this.get("user_id"),c=this.get("team_id");return b?config.WEB_ROOT+"game/"+a+"/user/"+b+"/team/"+c+"/":config.WEB_ROOT+"game/"+a+"/team/"+c+"/"}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){"use strict";app.Models.User=Backbone.Model.extend({defaults:{user_id:"",username:"",email:"Loading...",properties:{name:"Loading..",facebook:"Loading..",secret:"Loading..",team:"Loading..",photo_thumb:SPY,photo:SPY}},idAttribute:"user_id",url:function(){var a=app.Running.Games.getActiveGameId();return config.WEB_ROOT+"game/"+a+"/user/"+this.get("user_id")+"/"},joinGame:function(a,b,c){var d=this,e=app.Running.Games.getActiveGameId();app.Running.Games.setActiveGame(a).set("member",!0),this.save(null,{headers:{"X-DMAssassins-Game-Password":b,"X-DMAssassins-Team-Id":c},success:function(){d.trigger("join-game"),Backbone.history.navigate("my_profile",{trigger:!0})},error:function(b,c){401==c.status&&(b.trigger("join-error-password"),app.Running.Games.get(a).set("member",!1),app.Running.Games.setActiveGame(e,!0).set("member",!0))}})},setProperty:function(a,b,c){var d=this.get("properties");return d||(d={}),d[a]=b,this.set("properties",d),(void 0===c||c===!1)&&this.trigger("change"),this.get("properties")},getProperty:function(a){var b=this.get("properties");return b?void 0===b[a]?null:b[a]:null},ban:function(){var a=this;this.destroy({url:a.url()+"ban/"})},kill:function(){var a=this,b=this.url()+"kill/";$.post(b,function(){a.setProperty("alive","false")})},revive:function(){var a=this,b=this.url()+"revive/";$.post(b,function(){a.setProperty("alive","true")})},saveEmailSettings:function(a,b){var c={email:a,allow_email:b},d=this,e=this.url()+"email/";$.post(e,c,function(){d.set("email",a)})},quit:function(a){this.destroy({headers:{"X-DMAssassins-Secret":a},success:function(){return app.Running.Games.removeActiveGame()?void 0:void Backbone.history.navigate("#logout",{trigger:!0})}})},checkAccess:function(){app.Running.Router.before({},function(){})}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){"use strict";app.Collections.Games=Backbone.Collection.extend({model:app.Models.Game,parse:function(a){if(!a)return null;var b=[];return _.each(a.available,function(a){a.member=!1,b.push(a)}),_.each(a.member,function(a){a.member=!0,b.push(a)}),b},comparator:"game_name",active_game:null,url:function(){var a=app.Session.get("user_id");return config.WEB_ROOT+"user/"+a+"/game/"},addGame:function(a){var b=this,c=new app.Models.Game({game_id:a});c.fetch({success:function(){b.add(c),b.setActiveGame(c.get("game_id"))}})},joinGame:function(a,b,c){app.Running.User.joinGame(a,b,c),this.trigger("game-change")},setArbitraryActiveGame:function(a){var b=this.findWhere({game_started:!0});return b||(b=this.findWhere({game_started:!1})),this.setActiveGame(b,a),b},removeActiveGame:function(){return this.remove(this.active_game),this.setArbitraryActiveGame()},setActiveGame:function(a,b){var c=this.get(a);return c?(c.fetchProperties(),this.active_game=c,app.Session.set("game_id",a),app.Session.set("has_game",!0),void 0!==b&&b||this.trigger("game-change"),this.active_game):null},getActiveGame:function(){return this.active_game||this.setArbitraryActiveGame(!0),this.active_game},getActiveGameId:function(){var a=this.getActiveGame();return a?a.get("game_id"):null}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){"use strict";app.Collections.Teams=Backbone.Collection.extend({model:app.Models.Team,parse:function(a){return _.values(a)},url:function(){var a=app.Running.Games.getActiveGameId();return config.WEB_ROOT+"game/"+a+"/team/"}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){"use strict";app.Collections.Users=Backbone.Collection.extend({model:app.Models.User,parse:function(a){return _.values(a)},url:function(){var a=app.Running.Games.getActiveGameId();return config.WEB_ROOT+"game/"+a+"/users/"}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.AdminEditRulesView=Backbone.View.extend({template:_.template(a("#admin-edit-rules-template").html()),tagName:"div",initialize:function(){this.model=app.Running.RulesModel,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"fetch",this.render),this.listenTo(this.model,"set",this.render)},loadEditor:function(){var b=this;this.$el.find("#rules-editor").markdown({savable:!0,saveButtonClass:"btn btn-md btn-primary",footer:'<div class="saved hide">Saving...</div>',onSave:function(c){var d=c.getContent();b.model.set("rules",d),a(".saved").removeClass("hide"),b.model.save(null,{success:function(){a(".saved").text("Saved.").fadeOut(2e3,function(){a(this).text("Saving...")})}})}})},render:function(){var a=this.model.attributes;return this.$el.html(this.template(a)),this.loadEditor(),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.AdminGameSettingsView=Backbone.View.extend({template:_.template(a("#admin-game-settings-template").html()),tagName:"div",events:{"click .save-game":"saveGame","click .start-game":"startGameModal","click .start-game-submit":"startGame","click .end-game":"endGameModal","click .end-game-submit":"endGame"},initialize:function(){this.model=app.Running.Games.getActiveGame(),this.listenTo(this.model,"fetch",this.render),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"save",this.render)},saveGame:function(){var b=a("#game_name").val(),c=a("#game_password").val(),d=a("#teams_enabled").is(":checked")?"true":"false";this.model.set({game_name:b,game_password:c,game_teams_enabled:d},{silent:!0});var e=this.model.gameUrl();a(".save-game").text("Saving..."),this.model.save(null,{url:e,success:function(){a(".save-game").text("Saved"),setTimeout(function(){a(".save-game").text("Save")},1e3)}})},startGameModal:function(){a("#start_game_modal").modal()},startGame:function(){a("#start_game_modal").modal("hide");var b=this,c=this.model.gameUrl();a.post(c,function(){b.model.set("game_started",!0)}).error(function(a){alert(a.responseText)})},endGameModal:function(){a("#end_game_modal").modal()},endGame:function(){a("#end_game_modal").modal("hide");var b=this.model.gameUrl();this.model.destroy({url:b,success:function(){return app.Running.Games.setArbitraryActiveGame()?void 0:void Backbone.history.navigate("#logout",{trigger:!0})}})},render:function(){a(".modal-backdrop").remove();var b=this.model.attributes;return b.teams_enabled="true"==b.game_properties.teams_enabled,this.$el.html(this.template(b)),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.AdminUserView=Backbone.View.extend({template:_.template(a("#admin-user-template").html()),tagName:"div",initialize:function(a){this.model=a,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"fetch",this.render),this.listenTo(this.model,"save",this.render)},render:function(a){var b=this.model.attributes;for(var c in a)b[c]=a[c];return this.$el.html(this.template(b)),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.AdminUsersTeamsView=Backbone.View.extend({template:_.template(a("#admin-users-teams-template").html()),tagName:"ul",initialize:function(){this.collection=app.Running.Teams,this.listenTo(this.collection,"fetch",this.render),this.listenTo(this.collection,"change",this.render),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render)},render:function(){var a=function(a){return a.team_name},b={teams:_.sortBy(this.collection.toJSON(),a)},c=app.Running.User.getProperty("user_role");return b.is_admin=AuthUtils.requiresAdmin(c),this.$el.html(this.template(b)),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.AdminUsersView=Backbone.View.extend({template:_.template(a("#admin-users-template").html()),tagName:"div",events:{"click .ban-user":"banUserModal","click .kill-user":"killUserModal","click .revive-user":"reviveUserModal","click .ban-user-submit":"banUser","click .kill-user-submit":"killUser","click .revive-user-submit":"reviveUser","change select.user-team":"selectChangeTeam","change select.user-role":"selectChangeRole","click  a.team-name ":"sortByTeam","click .new-team-open":"showNewTeam","click .create-new-team":"createNewTeam","click .cancel-new-team":"cancelNewTeam","keyup .new-team-name":"newTeamKeypress","blur .new-team-form input":"blurTeamForm","click .edit-team":"showEditTeamForm","click .cancel-edit-team":"cancelEditTeam","click .save-edit-team":"saveEditTeam","click .delete-team":"deleteTeamModal","click .delete-team-submit":"deleteTeam"},team:void 0,initialize:function(){app.Running.User.getProperty("user_role");this.collection=app.Running.Users,this.userViews=[],this.teams_view=new app.Views.AdminUsersTeamsView,this.listenTo(this.collection,"fetch",this.render),this.listenTo(this.collection,"sync",this.render),this.listenTo(this.collection,"change",this.render),this.listenTo(this.collection,"remove",this.render)},banUserModal:function(b){var c=a(b.currentTarget).data("user-name"),d=a(b.currentTarget).data("user-id");a(".ban-user-submit").data("user-id",d),a("#ban_user_modal .user-name").text(c),a("#ban_user_modal").modal()},killUserModal:function(b){var c=a(b.currentTarget).data("user-name"),d=a(b.currentTarget).data("user-id");a(".kill-user-submit").data("user-id",d),a("#kill_user_modal .user-name").text(c),a("#kill_user_modal").modal()},reviveUserModal:function(b){var c=a(b.currentTarget).data("user-name"),d=a(b.currentTarget).data("user-id");a(".revive-user-submit").data("user-id",d),a("#revive_user_modal .user-name").text(c),a("#revive_user_modal").modal()},banUser:function(b){var c=a(b.currentTarget).data("user-id"),d=this.collection.get(c);d.ban(),a("#ban_user_modal").modal("hide")},killUser:function(b){var c=a(b.currentTarget).data("user-id"),d=this.collection.get(c);d.kill(),a("#kill_user_modal").modal("hide")},reviveUser:function(b){var c=a(b.currentTarget).data("user-id"),d=this.collection.get(c);d.revive(),a("#revive_user_modal").modal("hide")},selectChangeTeam:function(b){var c=a(b.currentTarget).data("user-id"),d=a(b.currentTarget).find("option:selected").val(),e=a(b.currentTarget).find("option:selected").text();this.addUserToTeam(c,d,e)},selectChangeRole:function(b){var c=a(b.currentTarget).data("user-id"),d=a(b.currentTarget).find("option:selected").val();return this.changeUserRole(c,d)},changeUserRole:function(b,c){var d=app.Running.Games.getActiveGameId(),e=config.WEB_ROOT+"game/"+d+"/user/"+b+"/role/";a.post(e,{role:c},function(){a("#role_saved_"+b).fadeIn(500,function(){a(this).fadeOut(2e3)})})},addUserToTeam:function(b,c,d){{var e=this,f=new app.Models.Team({user_id:b,team_id:c});app.Running.Users.get(b)}return f.save(null,{success:function(){e.collection.get(b).setProperty("team",d),a("#team_saved_"+b).fadeIn(500,function(){a(this).fadeOut(2e3)}),void 0!==e.team&&a("#user_"+b).remove()}})},makeDraggable:function(){var a=function(a,b){b.helper.find(".user").remove(),b.helper.removeClass("user-grid"),b.helper.find(".drag-img").removeClass("hide"),b.helper.find(".drag-img").animate({width:50,height:50},100)};this.$el.find(".user-grid").draggable({handle:".thumbnail",connectWith:"#team_list li",tolerance:"pointer",helper:"clone",forceHelperSize:!0,zIndex:5e3,start:a,cursorAt:{left:40,top:25}})},makeDroppable:function(){var b=this;this.$el.find("#team_list li.team-droppable").droppable({hoverClass:"drop-hover",tolerance:"pointer",drop:function(c,d){var e=d.helper.data("user-id"),f=a(this).data("team-id"),g=a(this).data("team-name");b.addUserToTeam(e,f,g)}})},addUser:function(a,b){b.logged_in=!1,a.get("user_id")==app.Session.get("user_id")&&(b.logged_in=!0);var c=new app.Views.AdminUserView(a);this.userViews.push(c),this.$el.find(".admin-users-body").append(c.render(b).el)},sortByTeam:function(b){b.preventDefault(),this.team=a(b.currentTarget).data("team-name"),this.team_id=a(b.currentTarget).data("team-id"),"SHOW_ALL"==this.team_id&&(this.team=void 0,this.team_id="all"),"NO_TEAM"==this.team_id&&(this.team="null",this.team_id="null"),this.render()},showNewTeam:function(a){a.preventDefault(),this.$el.find(".new-team-open").addClass("hide"),this.$el.find(".new-team-form").removeClass("hide"),this.$el.find(".new-team-form input").focus()},hideNewTeam:function(){this.$el.find(".new-team-open").removeClass("hide"),this.$el.find(".new-team-form").addClass("hide")},cancelNewTeam:function(a){a&&a.preventDefault(),this.hideNewTeam()},blurTeamForm:function(){var a=this.$el.find(".new-team input").val();a||this.hideNewTeam()},createNewTeam:function(b){b&&b.preventDefault();var c=this.$el.find(".new-team input").val();if(c){var d=app.Running.Games.getActiveGameId(),e=config.WEB_ROOT+"game/"+d+"/team/",f=this;a.post(e,{team_name:c},function(a){app.Running.Teams.add(a),f.teams_view.render(),f.selectActiveTeam(),f.makeDroppable()})}},newTeamKeypress:function(a){27==a.keyCode&&this.hideNewTeam(),13==a.keyCode&&this.createNewTeam(a)},showEditTeamForm:function(b){b.preventDefault();var c=a(b.currentTarget).data("team-id");a("#nav_team_"+c).find(".edit-team-form").removeClass("hide"),a("#nav_team_"+c).find(".team-display").addClass("hide")},hideEditTeam:function(b){var c=a(b.currentTarget).data("team-id");a("#nav_team_"+c).find(".team-display").removeClass("hide"),a("#nav_team_"+c).find(".edit-team-form").addClass("hide")},cancelEditTeam:function(a){a&&a.preventDefault(),this.hideEditTeam(a)},saveEditTeam:function(b){b.preventDefault();var c=a(b.currentTarget).data("team-id"),d=app.Running.Teams.get(c),e=a("#nav_team_"+c).find(".edit-team-name").val();if(e==d.get("team_name"))return void this.hideEditTeam(b);d.set("team_name",e),d.save()},deleteTeamModal:function(b){b.preventDefault();var c=a(b.currentTarget).data("team-name"),d=a(b.currentTarget).data("team-id");a(".delete-team-submit").data("team-name",c),a(".delete-team-submit").data("team-id",d),a("#delete_team_modal .team-name").text(c),a("#delete_team_modal").modal()},deleteTeam:function(b){var c=a(b.currentTarget).data("team-id"),d=a(b.currentTarget).data("team-name"),e=app.Running.Teams.get(c),f=this;e.destroy({success:function(){f.team==d&&(f.team="null",f.team_id="null"),app.Running.Users.each(function(a){a.getProperty("team")==d&&a.setProperty("team","null")}),f.render()}}),a("#delete_team_modal").modal("hide")},selectActiveTeam:function(){this.$el.find(".active").removeClass("active"),this.$el.find("#nav_team_"+this.team_id).addClass("active")},render:function(){var a={},b=app.Running.Games.getActiveGame(),c=!1;for(b&&(c=b.areTeamsEnabled()),a.teams_enabled=c,this.$el.html(this.template(a)),this.teams_view.setElement(this.$("#team_list")).render();this.userViews.length;){var d=this.userViews.pop();d.remove()}var a=this.collection.models;if(void 0!==this.team){var e=this;a=_.filter(a,function(a){return a.getProperty("team")==e.team})}this.selectActiveTeam();var f=function(a){return a.getProperty("first_name")};a=_.sortBy(a,f);var g=app.Running.User.getProperty("user_role"),e=this,h={teams:app.Running.Teams.toJSON(),roles:AuthUtils.getRolesMapFor(g,c),is_admin:AuthUtils.requiresAdmin(g),teams_enabled:c};return _.each(a,function(a){e.addUser(a,h)}),c&&(this.makeDraggable(),this.makeDroppable()),this.trigger("render"),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.AppView=Backbone.View.extend({el:"#app",initialize:function(){this.$body=a("#app_body")},renderPage:function(b){a(".modal-backdrop").remove(),this.$body.html(b.render().el)},setCurrentView:function(a){app.Running.currentView&&app.Running.currentView.remove(),app.Running.currentView=a}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.LeaderboardView=Backbone.View.extend({template:_.template(a("#leaderboard-template").html()),tagName:"div",initialize:function(){this.model=app.Running.LeaderboardModel,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"reset",this.render),this.listenTo(this.model,"fetch",this.render)},render:function(){var a=this.model.attributes;this.$el.html(this.template(a));var b=2,c=a.teams_enabled;c&&(b=3);var d={paging:!1,searching:!1,info:!1,order:[[b-1,"desc"],[b,"desc"]]};return this.$el.find("#user_leaderboard_table").dataTable(d),c&&(d.order=[[4,"desc"]],this.$el.find("#team_leaderboard_table").dataTable(d)),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.LoginView=Backbone.View.extend({template:_.template(a("#login-template").html()),events:{"click .btn-facebook":"login"},initialize:function(){this.model=app.Session},login:function(){this.model.login()},render:function(){return this.$el.html(this.template(this.model.attributes)),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.NavGameView=Backbone.View.extend({template:_.template(a("#nav-game-template").html()),el:"#games_dropdown",tagName:"ul",events:{"click li a.switch_game":"select"},initialize:function(){this.collection=app.Running.Games,this.listenTo(this.collection,"fetch",this.render),this.listenTo(this.collection,"change",this.render),this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"game-change",this.render)},handleJoin:function(){var a=_.findWhere(this.collection.toJSON(),{member:!1});return void 0===a?void this.hideJoin():void this.showJoin()},hideJoin:function(){this.$el.find("#nav_join_game").addClass("hide")},showJoin:function(){this.$el.find("#nav_join_game").removeClass("hide")},showCurrentGame:function(){var a=app.Running.Games.getActiveGameId();this.$el.find("#nav_"+a).removeClass("hide")},updateText:function(){if(a(".game_name").removeClass("hide"),"join_game"==Backbone.history.fragment)return this.showCurrentGame(),a("#games_header").text("Join Game"),a("#games_header_short").text("Join Game"),this;if("create_game"==Backbone.history.fragment)return this.showCurrentGame(),a("#games_header").text("Create Game"),a("#games_header_short").text("Create Game"),this;var b=this.collection.getActiveGame();if(!b)return this;var c=b.get("game_name");a("#games_header").text(c);var d=9;c.length>d&&(c=c.substr(0,d-3)+"..."),a("#games_header_short").text(c);var e=app.Running.Games.getActiveGameId();this.$el.find("#nav_"+e).addClass("hide")},render:function(){return this.$el.html(this.template({games:_.where(this.collection.toJSON(),{member:!0})})),this.handleJoin(),this.updateText(),this},select:function(b){var c=a(b.target).attr("game_id");app.Running.Games.setActiveGame(c)}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.NavView=Backbone.View.extend({template:_.template(a("#nav-template").html()),el:"#nav_body",tagName:"nav",events:{"click li a":"select"},initialize:function(){this.NavGameView=app.Running.NavGameView,this.listenTo(app.Running.TargetModel,"fetch",this.handleTarget),this.listenTo(app.Running.TargetModel,"change",this.handleTarget),this.listenTo(app.Running.User,"fetch",this.render),this.listenTo(app.Running.User,"change",this.render),this.listenTo(app.Running.Games,"game-change",this.render)},render:function(){var a=app.Running.User.getProperty("user_role"),b={};b.is_captain=AuthUtils.requiresCaptain(a),b.is_admin=AuthUtils.requiresAdmin(a),this.$el.html(this.template(b)),this.handleTarget();var c=this.$el.find("#nav_"+Backbone.history.fragment);return this.highlight(c),app.Running.NavGameView&&app.Running.NavGameView.setElement(this.$("#games_dropdown")).render(),this},select:function(b){var c=b.currentTarget;return a(c).hasClass("disabled")||a(c).hasClass("dropdown-toggle")?void b.preventDefault():(a(".navbar-collapse.in").collapse("hide"),void this.highlight(c))},highlight:function(b){if(!a(b).hasClass("dropdown_parent")){if(a(b).hasClass("dropdown_item")){var c=a(b).attr("dropdown"),d="#"+c+"_parent";b=d}a(".active").removeClass("active"),a(b).addClass("active")}},handleAdmin:function(){var b=app.Running.User.getProperty("user_role"),c=AuthUtils.requiresCaptain(b);return c?void a("#admin_parent").removeClass("hide"):void a("#admin_parent").addClass("hide")},handleTarget:function(){var a=app.Running.Games.getActiveGame();return a&&a.get("game_started")&&app.Running.TargetModel.get("user_id")?void this.enableTarget():void this.disableTarget()},enableTarget:function(){this.$el.find("#nav_target").removeClass("disabled"),this.$el.find("#nav_target a").removeClass("disabled")},disableTarget:function(){this.$el.find("#nav_target").addClass("disabled"),this.$el.find("#nav_target a").addClass("disabled")}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.ProfileView=Backbone.View.extend({template:_.template(a("#profile-template").html()),tagName:"div",events:{"click .thumbnail":"showFullImage","click #quit":"showQuitModal","click #quit_game_confirm":"quitGame","click #email_settings":"showEmailModal","click #email_settings_save":"saveEmailSettings","keyup #email":"emailEnter"},showFullImage:function(){a("#photoModal").modal()},showQuitModal:function(){var b={quit_game_name:app.Running.Games.getActiveGame().get("game_name")},c=_.template(a("#quit-modal-template").html()),d=c(b);a("#quit_modal_wrapper").html(d),a("#quit_modal").modal()},quitGame:function(){var a=this.$el.find("#quit_secret").val();this.model.quit(a)},showEmailModal:function(){a("#email_modal").modal()},emailEnter:function(a){13==a.which&&this.saveEmailSettings()},saveEmailSettings:function(){var b=a("#email").val(),c=a("#allow_email").is(":checked")?"true":"false";this.model.saveEmailSettings(b,c),a("#email_modal").modal("hide")},initialize:function(){this.model=app.Running.User,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"fetch",this.render),this.listenTo(this.model,"destroy",this.destroyCallback),this.listenTo(this.model,"set",this.render)},destroyCallback:function(){a("#quit_modal").modal("hide")},render:function(){a(".modal-backdrop").remove();var b=this.model.attributes;b.teams_enabled=!1;var c=app.Running.Games.getActiveGame();c&&(b.teams_enabled=c.areTeamsEnabled()),b.allow_email="true"==b.properties.allow_email;var d=app.Running.User.getProperty("user_role"),e=!AuthUtils.requiresCaptain(d);return b.allow_quit=e,this.$el.html(this.template(b)),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.RulesView=Backbone.View.extend({template:_.template(a("#rules-template").html()),tagName:"div",initialize:function(){this.model=app.Running.RulesModel,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"fetch",this.render),this.listenTo(this.model,"set",this.render)},render:function(){var a=this.model.attributes;return a.rules=marked(a.rules),this.$el.html(this.template(a)),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.SelectGameView=Backbone.View.extend({template:_.template(a("#select-game-template").html()),tagName:"div",events:{"click .show-create-game":"showCreateGame","click .show-join-game":"showJoinGame","click .create-game-submit":"createGame","click .join-game-submit":"joinGame","click .create-or-join-back":"goBack","click #create_game_need_password":"togglePassword","change #games":"checkFields"},loaded_from:"login",initialize:function(){this.collection=app.Running.Games,this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"fetch",this.render),this.listenTo(app.Running.User,"join-error-password",this.badPassword)},showCreateGame:function(){a(".logo").addClass("hide"),a("#create-or-join").addClass("hide"),a("#create-game").addClass("select-game-active"),a("#create-game").removeClass("hide")},showJoinGame:function(){a(".logo").addClass("hide"),a("#create-or-join").addClass("hide"),a("#join-game").addClass("select-game-active"),a("#join-game").removeClass("hide")},goBack:function(){return app.Running.Games.getActiveGameId()?void app.Running.Router.back():(a(".select-game-active").addClass("hide").removeClass("select-game-active"),a("#create-or-join").removeClass("hide"),void a(".logo").removeClass("hide"))},createGame:function(b){b.preventDefault();var c=a("#create_game_name").val(),d=null;a("#create_game_need_password").is(":checked")&&(d=a("#create_game_password").val());var e=this;this.collection.create({game_name:c,game_password:d},{success:function(a){e.finish(a)}})},loadJoinGame:function(){var a=this;a.showJoinGame(),this.collection.fetch({wait:!0,success:function(){a.showJoinGame()}})},joinGame:function(b){b.preventDefault();var c=this.$el.find("#games option:selected"),d=c.val(),e="true"==c.attr("game_has_password"),f=e?a("#join_game_password").val():"",g="disabled"!=this.$el.find("#join_game_team").attr("disabled"),h=this.$el.find("#join_game_team option:selected").val();
return g&&!h?void this.badTeam():void app.Running.Games.joinGame(d,f,h)},badPassword:function(){a("#join_password_block").addClass("has-error"),a("label[for=join_game_password]").text("Invalid Password:")},badTeam:function(){a("#join_team_block").addClass("has-error"),a("label[for=join_game_team]").text("Must Select A Team:")},fixFields:function(){this.$el.find(".has-error").removeClass("has-error"),this.$el.find("label[for=join_game_password]").text("Password:"),this.$el.find("label[for=join_game_team]").text("Team:")},finish:function(a){app.Running.Games.setActiveGame(a.get("game_id")),Backbone.history.navigate("my_profile",{trigger:!0})},togglePassword:function(b){a("#create_game_password").attr("disabled",!b.target.checked)},noTeams:function(){var a=this.$el.find("#join_game_team");a.attr("disabled",!0),a.find("#team_placeholder").text("This Game Doesn't Have Teams")},checkFields:function(){this.fixFields();var b=this.$el.find("#games option:selected"),c="true"==b.attr("game_has_password"),d=this.$el.find("#join_game_password"),e=c?"":"This Game Has No Password";d.attr("disabled",!c),d.val(e);var f=b.val(),g=app.Running.Games.get(f);if(g){var h=this.$el.find("#join_game_team");h.find("#team_placeholder").text("Loading..");var i=this,j=config.WEB_ROOT+"game/"+f+"/team/";app.Running.Teams.fetch({url:j,success:function(){h.attr("disabled",!1);var b=_.template(a("#select-game-team-option").html()),c=b({teams:app.Running.Teams.toJSON()});h.html(c),app.Running.Teams.length||i.noTeams()},error:function(){i.noTeams()}})}},render:function(){return this.$el.html(this.template({games:_.where(this.collection.toJSON(),{member:!1})})),this.checkFields(),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(a){"use strict";app.Views.TargetView=Backbone.View.extend({template:_.template(a("#target-template").html()),tagName:"div",events:{"click .thumbnail":"showFullImage","click #kill":"kill"},showFullImage:function(){a("#photoModal").modal()},initialize:function(){this.model=app.Running.TargetModel,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"fetch",this.render),this.listenTo(this.model,"set",this.render)},kill:function(){var a=this.$el.find("#secret").val(),b=this;this.model.destroy({headers:{"X-DMAssassins-Secret":a},success:function(){b.model.fetch()}})},render:function(){var a=this.model.attributes;return a.teams_enabled=app.Running.Games.getActiveGame().areTeamsEnabled(),this.$el.html(this.template(a)),this}})}(jQuery);var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){app.Routers.BaseRouter=Backbone.Router.extend({before:function(){},after:function(){},route:function(a,b,c){_.isRegExp(a)||(a=this._routeToRegExp(a)),_.isFunction(b)&&(c=b,b=""),c||(c=this[b]);var d=this;return Backbone.history.route(a,function(e){var f=d._extractParameters(a,e),g=function(){c&&c.apply(d,f),d.trigger.apply(d,["route:"+b].concat(f)),d.trigger("route",b,f),Backbone.history.trigger("route",d,b,f),d.after.apply(d,f)};d.before.apply(d,[f,g])}),this}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};!function(){app.Routers.Router=app.Routers.BaseRouter.extend({history:[],routes:{"":"my_profile",login:"login",logout:"logout",target:"target",my_profile:"my_profile",multigame:"multigame",leaderboard:"leaderboard",create_game:"create_game",join_game:"join_game",rules:"rules",users:"users",edit_rules:"edit_rules",switch_game:"switch_game",game_settings:"game_settings"},requiresTarget:["#target"],requiresJustAuth:["#multigame",""],requiresGameAndAuth:["#my_profile","#join_game","#leaderboard","#rules"],requiresCaptain:["#users"],requiresAdmin:["#edit_rules","#game_settings","#plot_twists"],noNav:["login","multigame"],preventAccessWhenAuth:["#login"],redirectWithoutGame:"#multigame",redirectWithoutGameStarted:"my_profile",redirectWithoutAuth:"#login",before:function(a,b){var c=app.Session.get("authenticated"),d=Backbone.history.location.hash,e=_.contains(this.requiresGameAndAuth,d),f=_.contains(this.requiresJustAuth,d),g=_.contains(this.preventAccessWhenAuth,d),h=_.contains(this.requiresTarget,d),i="true"==app.Session.get("has_game"),j=!!app.Running.TargetModel.get("user_id")&&app.Running.Games.getActiveGame().get("game_started"),k=_.contains(this.requiresCaptain,d),l=_.contains(this.requiresAdmin,d),m=app.Running.User.getProperty("user_role"),n=AuthUtils.requiresCaptain(m),o=AuthUtils.requiresAdmin(m);if(!f&&!e||c)if(e&&!i)Backbone.history.navigate(this.redirectWithoutGame,{trigger:!0});else if(h&&!j)Backbone.history.navigate(this.redirectWithoutTarget,{trigger:!0});else if(c&&g)Backbone.history.navigate("",{trigger:!0});else if(k&&!n)Backbone.history.navigate("",{trigger:!0});else{if(!l||o)return b();Backbone.history.navigate("",{trigger:!0})}else app.Session.set("redirect_from",d),Backbone.history.navigate(this.redirectWithoutAuth,{trigger:!0})},after:function(){this.history.push(Backbone.history.fragment)},back:function(){var a=this.history.pop();Backbone.history.navigate(a,{trigger:!0})},login:function(){var a=new app.Views.LoginView;app.Running.AppView.setCurrentView(a),this.render()},logout:function(){app.Session.clear(),this.navigate("login",!0)},multigame:function(){var a=new app.Views.SelectGameView;app.Running.AppView.setCurrentView(a),app.Running.currentView.collection.fetch(),this.render()},target:function(){var a=new app.Views.TargetView;app.Running.AppView.setCurrentView(a),this.render()},create_game:function(){var a=new app.Views.SelectGameView;app.Running.AppView.setCurrentView(a),this.render(),app.Running.currentView.showCreateGame()},join_game:function(){var a=new app.Views.SelectGameView;app.Running.AppView.setCurrentView(a),this.render(),app.Running.currentView.loadJoinGame(app.Session.get("user_id"))},my_profile:function(){var a=new app.Views.ProfileView;app.Running.AppView.setCurrentView(a),this.render()},leaderboard:function(){var a=new app.Views.LeaderboardView;app.Running.AppView.setCurrentView(a),app.Running.currentView.model.fetch(),this.render()},rules:function(){var a=new app.Views.RulesView;app.Running.AppView.setCurrentView(a),this.render()},users:function(){var a=new app.Views.AdminUsersView;app.Running.AppView.setCurrentView(a),app.Running.currentView.collection.reset(),app.Running.currentView.collection.fetch(),app.Running.Teams.fetch(),this.render()},edit_rules:function(){var a=new app.Views.AdminEditRulesView;app.Running.AppView.setCurrentView(a),app.Running.currentView.model.fetch(),this.render()},game_settings:function(){var a=new app.Views.AdminGameSettingsView;app.Running.AppView.setCurrentView(a),this.render()},preventSwitchGameBack:["join_game","create_game"],switch_game:function(){var a=this.history[this.history.length-1];return void 0===a||_.contains(this.preventSwitchGameBack,a)?void Backbone.history.navigate("my_profile",{trigger:!0}):void this.back()},render:function(){var a=Backbone.history.fragment;-1!=this.noNav.indexOf(Backbone.history.fragment)||"login"==a||app.Running.NavView?-1!=this.noNav.indexOf(Backbone.history.fragment)&&app.Running.NavView&&(app.Running.NavView.$el.html(""),app.Running.NavView=null,app.Running.navGameView=null):(app.Running.NavGameView||(app.Running.NavGameView=new app.Views.NavGameView,app.Running.NavGameView.render()),app.Running.NavView=new app.Views.NavView,app.Running.NavView=app.Running.NavView.render()),app.Running.NavView&&-1==this.noNav.indexOf(Backbone.history.fragment)&&(""===a&&(a="my_profile"),app.Running.NavView.highlight("#nav_"+a),app.Running.NavView.handleTarget(),app.Running.NavGameView.updateText()),app.Running.AppView.renderPage(app.Running.currentView)}})}();var app=app||{Collections:{},Models:{},Views:{},Routers:{},Running:{},Session:{}};$(function(){"use strict";Raven.config(config.SENTRY_DSN,{}).install(),app.Running.AppView=new app.Views.AppView,app.Running.AppView.render(),app.Session=new app.Models.Session,app.Session.setAuthHeader(),app.Running.Games=new app.Collections.Games,app.Running.User=new app.Models.User,app.Running.TargetModel=new app.Models.Target,app.Running.LeaderboardModel=new app.Models.Leaderboard,app.Running.RulesModel=new app.Models.Rules,app.Running.Users=new app.Collections.Users,app.Running.Teams=new app.Collections.Teams,app.Running.User.listenTo(app.Running.Games,"game-change",app.Running.User.fetch),app.Running.TargetModel.listenTo(app.Running.Games,"game-change",app.Running.TargetModel.fetch),app.Running.LeaderboardModel.listenTo(app.Running.Games,"game-change",app.Running.LeaderboardModel.fetch),app.Running.RulesModel.listenTo(app.Running.Games,"game-change",app.Running.RulesModel.fetch),app.Running.User.listenTo(app.Running.User,"fetch",app.Running.User.checkAccess),app.Running.User.listenTo(app.Running.User,"change",app.Running.User.checkAccess),app.Running.Router=new app.Routers.Router,Backbone.history.start()});var config={ENV:"DEV",LOCAL_ROOT:"/Users/Matthew/Dropbox/Go/src/GitHub.com/mattgerstman/DMAssassins/webapp/",WEB_ROOT:"http://assassins.com:8000/",APP_ID:649985815097586,SENTRY_DSN:"https://b4ab4d3478f440e0bf658313a71b9847@app.getsentry.com/30968"};